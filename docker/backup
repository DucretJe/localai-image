FROM golang:bookworm@sha256:337543447173c2238c78d4851456760dcc57c1dfa8c3bcd94cbee8b0f7b32ad0 as builder

# renovate: datasource=repology depName=debian_12/abseil versioning=loose
ENV ABSL_VER 20220623.1
# renovate: datasource=repology depName=debian_12/build-essential-mipsen versioning=loose
ENV BUILDESSENTIAL_VER 12.9
# renovate: datasource=repology depName=debian_12/ca-certificates versioning=loose
ENV CACERTIFICATES_VER 20230311
# renovate: datasource=repology depName=debian_12/cmake versioning=loose
ENV CMAKE_VER 3.25.1
# renovate: datasource=repology depName=debian_12/gcc-12 versioning=loose
ENV GCC_VER 12.2.0
# renovate: datasource=repology depName=debian_12/git versioning=loose
ENV GIT_VER 2.39.2
# renovate: datasource=repology depName=debian_12/libtool versioning=loose
ENV LIBTOOL_VER 2.4.7
# renovate: datasource=repology depName=debian_12/make-dfsg versioning=loose
ENV MAKE_VER 4.3
# renovate: datasource=repology depName=debian_12/patch versioning=loose
ENV PATCH_VER 2.7.6
# renovate: datasource=repology depName=debian_12/protobuf versioning=loose
ENV PROTOBUF_VER v25.1

RUN apt-get update && apt-get install --no-install-recommends -y \
    "build-essential=${BUILDESSENTIAL_VER}*" \
    "ca-certificates=${CACERTIFICATES_VER}" \
    "cmake=${CMAKE_VER}*" \
    "?and(?exact-name(gcc-12),?version(:${GCC_VER}))" \
    "?and(?exact-name(git),?version(:${GIT_VER}))" \
    "libabsl-dev=${ABSL_VER}*" \
    "libtool=${LIBTOOL_VER}*" \
    "make=${MAKE_VER}*" \
    "patch=${PATCH_VER}*" \
    build-essential && \
    rm -rf /var/lib/apt/lists/*

RUN wget https://github.com/google/protobuf/releases/download/${PROTOBUF_VER}/protobuf-${PROTOBUF_VER#v}.tar.gz && \
    tar xzf protobuf-${PROTOBUF_VER#v}.tar.gz && \
    cd protobuf-${PROTOBUF_VER#v} && \
    ./configure && \
    make && \
    make check && \
    make install && \
    ldconfig

FROM builder as build

ENV CMAKE_PREFIX_PATH /usr/local/lib

COPY protobuf-config.make /usr/local/lib

RUN git clone https://github.com/go-skynet/LocalAI && \
    cd LocalAI && \
    make build

